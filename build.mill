//| mill-version: 1.0.0
//| mill-jvm-opts: ["-XX:NonProfiledCodeHeapSize=250m", "-XX:ReservedCodeCacheSize=500m", "-Xss10m"]
//| mill-opts: ["--jobs=0.5C"]
//| mvnDeps:
//| - com.github.lolgab::mill-mima_mill1:0.2.0
package build

// imports
import mill._
import mill.scalalib._
import mill.util.VcsVersion
import mill.scalalib.publish._
import mill.scalajslib._
import mill.scalanativelib._
import mill.scalanativelib.api.{LTO, ReleaseMode}
import com.github.lolgab.mill.mima._

val scala212  = "2.12.18"
val scala213  = "2.13.11"

val scala3   = "3.3.5"
val scala3NamedTuples = "3.7.0"
val scalaJSNamedTuples = "1.19.0" // the version of scala.js that the scala3-library is built for.
val scalaNativeNamedTuples = "0.5.7" // the version of scala.native that the scala3-library is built for.
val scalaNative = "0.5.5"
val acyclic = "0.3.12"

val sourcecode = "0.4.2"

val dottyCustomVersion = Option(sys.props("dottyVersion"))

val scala2JVMVersions = Seq(scala212, scala213)
val scalaVersions = scala2JVMVersions ++ Seq(scala3) ++ dottyCustomVersion

trait CommonPlatformModule extends ScalaModule with PlatformScalaModule{
  def crossScalaVersion: String
  def platformSources = Task.Sources(
    Option.when(crossScalaVersion != scala212)(os.sub / "src-2.13+").toSeq ++
      (platformCrossSuffix match {
        case "jvm" => Seq(os.sub / "src-jvm-native")
        case "native" => Seq(os.sub / "src-js-native", os.sub / "src-jvm-native")
        case "js" => Seq(os.sub / "src-js-native")
      })*
  )
  def sources = Task { super.sources() ++ platformSources() }
}

trait CommonPublishModule
  extends ScalaModule with PublishModule with Mima with CrossScalaModule { outer =>

  def publishVersion = VcsVersion.vcsState().format()
  def mimaReportBinaryIssues() =
    if (this.isInstanceOf[ScalaNativeModule] || this.isInstanceOf[ScalaJSModule]) Task.Command{}
    else super.mimaReportBinaryIssues()

  def mimaPreviousVersions = Seq(
    "4.0.0",
  )
  def isDotty = crossScalaVersion.startsWith("0") || crossScalaVersion.startsWith("3")
  def pomSettings = PomSettings(
    description = artifactName(),
    organization = "com.lihaoyi",
    url = "https://github.com/lihaoyi/upickle",
    licenses = Seq(License.MIT),
    versionControl = VersionControl.github(owner = "com-lihaoyi", repo = "upickle"),
    developers = Seq(
      Developer("lihaoyi", "Li Haoyi","https://github.com/lihaoyi")
    )
  )

  def publishProperties: T[Map[String, String]] = super.publishProperties() ++ Map(
    "info.releaseNotesURL" -> "https://com-lihaoyi.github.io/upickle/#VersionHistory"
  )

  def versionScheme: T[Option[VersionScheme]] = Task{ Some(VersionScheme.SemVerSpec) }

  def templatesFolders = sourcesFolders.map{src =>
    val s"src$rest" = src.last
    src / os.up / s"templates$rest"
  }
  def templates = Task.Sources(templatesFolders*)
  def generatedSources = Task {
    for{
      pathRef <- templates()
      p <- if (os.exists(pathRef.path)) os.list(pathRef.path) else Nil
      rename <- Seq("Char", "Byte")
    }{
      def replace(s: String) = s.replace("Elem", rename).replace("elem", rename.toLowerCase)
      os.write(Task.dest / replace(p.last), replace(os.read(p)))
    }

    Seq(PathRef(Task.dest))
  }

  def scalacOptions = Task {
    Seq("-unchecked", "-encoding", "utf8", "-feature") ++
    Seq("-opt:l:method", "-Xfatal-warnings", "-deprecation").filter(_ => !scalaVersion().startsWith("3."))
  }

  trait CommonTestModule0 extends ScalaModule with TestModule.Utest {
    def mvnDeps = {
      Seq(mvn"com.lihaoyi::utest::0.8.3") ++
      Option.when(!scalaVersion().startsWith("3."))(mvn"com.lihaoyi:::acyclic:$acyclic")
    }

    def scalacOptions = super.scalacOptions() ++
      Seq(
        "-Ximplicit-search-limit",
        "200000",
        "-Xmax-inlines",
        "155"
      ).filter(_ => scalaVersion().startsWith("3."))
  }
}

trait CommonJvmModule extends CommonPublishModule with CommonPlatformModule{
  trait CommonTestModule extends ScalaTests with CommonTestModule0
}

trait CommonJsModule extends CommonPublishModule with ScalaJSModule with CommonPlatformModule {
  def scalaJSVersion = "1.13.1"

  private def sourceMapOptions = Task.Anon {
    val vcsState = VcsVersion.vcsState()
    vcsState.lastTag.collect {
      case tag if vcsState.commitsSinceLastTag == 0 =>
        val baseUrl = pomSettings().url.replace("github.com", "raw.githubusercontent.com")
        val sourcesOptionName = if(crossScalaVersion.startsWith("3.")) "-scalajs-mapSourceURI" else "-P:scalajs:mapSourceURI"
        s"$sourcesOptionName:${mill.api.BuildCtx.workspaceRoot.toIO.toURI}->$baseUrl/$tag/"
    }
  }

  def scalacOptions = super.scalacOptions() ++ sourceMapOptions()

  trait CommonTestModule extends ScalaJSTests with CommonTestModule0
}

trait CommonNativeModule extends CommonPublishModule with ScalaNativeModule with CommonPlatformModule {
  def scalaNativeVersion = scalaNative

  trait CommonTestModule extends ScalaNativeTests with CommonTestModule0
}

object upack extends Module {
  object js extends Cross[JsModule](scalaVersions)
  trait JsModule extends CommonJsModule {
    def moduleDeps = Seq(upickle.core.js())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(ujson.js().test, upickle.core.js().test)
    }
  }

  object jvm extends Cross[JvmModule](scalaVersions)
  trait JvmModule extends CommonJvmModule {
    def moduleDeps = Seq(upickle.core.jvm())
    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(ujson.jvm().test, upickle.core.jvm().test)
      def forkEnv = super.forkEnv() ++ Map("EXAMPLE_JSON" -> exampleJson().path.toString)
    }
  }

  object native extends Cross[NativeModule](scalaVersions)
  trait NativeModule extends CommonNativeModule {
    def moduleDeps = Seq(upickle.core.native())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(ujson.native().test, upickle.core.native().test)
    }
  }
}

object ujson extends Module{
  object js extends Cross[JsModule](scalaVersions)
  trait JsModule extends CommonJsModule {
    def moduleDeps = Seq(upickle.core.js())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(upickle.core.js().test)
    }
  }

  object jvm extends Cross[JvmModule](scalaVersions)
  trait JvmModule extends CommonJvmModule{
    def moduleDeps = Seq(upickle.core.jvm())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(upickle.core.jvm().test)
      def forkEnv = super.forkEnv() ++ Map("EXAMPLE_JSON" -> exampleJson().path.toString)
    }
  }

  object native extends Cross[NativeModule](scalaVersions)
  trait NativeModule extends CommonNativeModule {
    def moduleDeps = Seq(upickle.core.native())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(upickle.core.native().test)
    }
  }

  object argonaut extends Cross[ArgonautModule](scala2JVMVersions)
  trait ArgonautModule extends CommonPublishModule{
    def moduleDeps = Seq(ujson.jvm())
    def mvnDeps = Seq(mvn"io.argonaut::argonaut:6.2.6")
  }

  object json4s extends Cross[Json4sModule](scalaVersions)
  trait Json4sModule extends CommonPublishModule{
    def moduleDeps = Seq(ujson.jvm())
    def mvnDeps = Seq(
      mvn"org.json4s::json4s-ast:4.0.7",
      mvn"org.json4s::json4s-native:4.0.7"
    )
  }

  object circe extends Cross[CirceModule](scalaVersions)
  trait CirceModule extends CommonPublishModule{
    def moduleDeps = Seq(ujson.jvm())
    val circeVersion = "0.14.9"
    def mvnDeps = Seq(mvn"io.circe::circe-parser:$circeVersion")
  }

  object play extends Cross[PlayModule](scala2JVMVersions)
  trait PlayModule extends CommonPublishModule{
    def moduleDeps = Seq(ujson.jvm())
    val playJsonVersion = "2.9.4"
    def mvnDeps = Seq(mvn"com.typesafe.play::play-json:$playJsonVersion")
  }
}

object upickle extends Module{
  object core extends Module {
    trait CommonCoreModule extends CommonPublishModule {
      def mvnDeps = Seq(mvn"com.lihaoyi::geny::1.1.1")
    }

    object js extends Cross[CoreJsModule](scalaVersions)
    trait CoreJsModule extends CommonJsModule with CommonCoreModule {
      object test extends CommonTestModule
    }

    object jvm extends Cross[CoreJvmModule](scalaVersions)
    trait CoreJvmModule extends CommonJvmModule with CommonCoreModule{
      object test extends CommonTestModule
    }

    object native extends Cross[CoreNativeModule](scalaVersions)
    trait CoreNativeModule extends CommonNativeModule with CommonCoreModule {
      object test extends CommonTestModule
    }
  }

  object implicits extends Module {
    trait ImplicitsModule extends CommonPublishModule{
      def compileMvnDeps = Task {
        Seq(
          mvn"com.lihaoyi:::acyclic:$acyclic",
          mvn"org.scala-lang:scala-reflect:${scalaVersion()}"
        ).filter(_ => !isDotty)
      }

      def generatedSources = Task {
        val dir = Task.ctx().dest
        val file = dir / "upickle" / "Generated.scala"
        os.makeDir(dir / "upickle")
        val tuples = (1 to 22).map{ i =>
          def commaSeparated(s: Int => String) = (1 to i).map(s).mkString(", ")
          val writerTypes = commaSeparated(j => s"T$j: Writer")
          val readerTypes = commaSeparated(j => s"T$j: Reader")
          val typeTuple = commaSeparated(j => s"T$j")
          val implicitWriterTuple = commaSeparated(j => s"implicitly[Writer[T$j]]")
          val implicitReaderTuple = commaSeparated(j => s"implicitly[Reader[T$j]]")
          val lookupTuple = commaSeparated(j => s"x(${j-1})")
          val fieldTuple = commaSeparated(j => s"x._$j")
          s"""
          implicit def Tuple${i}Writer[$writerTypes]: TupleNWriter[Tuple$i[$typeTuple]] =
            new TupleNWriter[Tuple$i[$typeTuple]](Array($implicitWriterTuple), x => if (x == null) null else Array($fieldTuple))
          implicit def Tuple${i}Reader[$readerTypes]: TupleNReader[Tuple$i[$typeTuple]] =
            new TupleNReader(Array($implicitReaderTuple), x => Tuple$i($lookupTuple).asInstanceOf[Tuple$i[$typeTuple]])
          """
        }

        os.write(file, s"""
        package upickle.implicits
        /**
         * Auto-generated picklers and unpicklers, used for creating the 22
         * versions of tuple-picklers and case-class picklers
         */
        trait Generated extends TupleReadWriters { self: upickle.core.Config =>
          ${tuples.mkString("\n")}
        }
      """)
        Seq(PathRef(dir))
      }
    }

    object js extends Cross[JsModule](scalaVersions)
    trait JsModule extends ImplicitsModule with CommonJsModule {
      def moduleDeps = Seq(core.js())

      object test extends CommonTestModule{
        def moduleDeps = super.moduleDeps ++ Seq(ujson.js().test, core.js().test)
      }
    }

    object jvm extends Cross[JvmModule](scalaVersions)
    trait JvmModule extends ImplicitsModule with CommonJvmModule{
      def moduleDeps = Seq(core.jvm())

      object test extends CommonTestModule{
        def moduleDeps = super.moduleDeps ++ Seq(ujson.jvm().test, core.jvm().test)
      }
    }

    object native extends Cross[NativeModule](scalaVersions)
    trait NativeModule extends ImplicitsModule with CommonNativeModule {
      def moduleDeps = Seq(core.native())

      object test extends CommonTestModule{
        def moduleDeps = super.moduleDeps ++ Seq(ujson.native().test, core.native().test)
      }
    }

    object `named-tuples` extends Module {
      object js extends Cross[JsModule](scala3NamedTuples)
      trait JsModule extends CommonJsModule {
        def scalaJSVersion = scalaJSNamedTuples
        def moduleDeps = Seq(upickle.js())
        override def mimaPreviousVersions = Seq.empty[String] // no previous versions
        override def mimaPreviousArtifacts = Seq.empty[Dep] // no previous versions

        object test extends CommonTestModule
      }

      object jvm extends Cross[JvmModule](scala3NamedTuples)
      trait JvmModule extends CommonJvmModule {
        def moduleDeps = Seq(upickle.jvm())
        override def mimaPreviousVersions = Seq.empty[String] // no previous versions
        override def mimaPreviousArtifacts = Seq.empty[Dep] // no previous versions

        object test extends CommonTestModule
      }

      object native extends Cross[NativeModule](scala3NamedTuples)
      trait NativeModule extends CommonNativeModule {
        def scalaNativeVersion = scalaNativeNamedTuples
        def moduleDeps = Seq(upickle.native())
        override def mimaPreviousVersions = Seq.empty[String] // no previous versions
        override def mimaPreviousArtifacts = Seq.empty[Dep] // no previous versions

        object test extends CommonTestModule
      }
    }
  }

  trait UpickleModule extends CommonPublishModule {
    def compileMvnDeps =
      Seq(
        mvn"com.lihaoyi:::acyclic:$acyclic",
        mvn"org.scala-lang:scala-reflect:${scalaVersion()}",
        mvn"org.scala-lang:scala-compiler:${scalaVersion()}"
      ).filter(_ => !isDotty)
  }

  object jvm extends Cross[JvmModule](scalaVersions)
  trait JvmModule extends UpickleModule with CommonJvmModule{
    def moduleDeps = Seq(ujson.jvm(), upack.jvm(), implicits.jvm())

    object test extends CommonTestModule{
      def moduleDeps =
        super.moduleDeps ++
        Seq(core.jvm().test) ++
        (
          if (isDotty) Nil
          else Seq(ujson.argonaut(), ujson.circe(), ujson.json4s(), ujson.play())
        )
    }

    object testNonUtf8 extends CommonTestModule {
      def forkArgs = Seq("-Dfile.encoding=US-ASCII")
    }

    object testSlow extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(JvmModule.this.test)
    }
  }

  object js extends Cross[JsModule](scalaVersions)
  trait JsModule extends UpickleModule with CommonJsModule {
    def moduleDeps = Seq(ujson.js(), upack.js(), implicits.js())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(core.js().test)
    }
  }

  object native extends Cross[NativeModule](scalaVersions)
  trait NativeModule extends UpickleModule with CommonNativeModule {
    def moduleDeps = Seq(ujson.native(), upack.native(), implicits.native())

    object test extends CommonTestModule{
      def moduleDeps = super.moduleDeps ++ Seq(core.native().test)
      def allSourceFiles = Task{ super.allSourceFiles().filter(_.path.last != "DurationsTests.scala") }
    }
  }
}

def exampleJson = Task.Source(moduleDir / "exampleJson")

trait BenchModule extends CommonPlatformModule{
  def crossScalaVersion = scala213
  def scalaVersion = scala213
  def mvnDeps = Seq(
    mvn"io.circe::circe-core::0.14.9",
    mvn"io.circe::circe-generic::0.14.9",
    mvn"io.circe::circe-parser::0.14.9",
    mvn"com.typesafe.play::play-json::2.9.4",
    mvn"io.argonaut::argonaut:6.2.6",
    mvn"org.json4s::json4s-ast:3.6.12",
    mvn"com.lihaoyi::sourcecode::$sourcecode",
  )
}

object bench extends Module {
  object js extends BenchModule with ScalaJSModule {
    def scalaJSVersion = "1.16.0"
    def moduleDeps = Seq(upickle.js(scala213).test)
  }

  object jvm extends BenchModule {
    def moduleDeps = Seq(upickle.jvm(scala213).test)
  }

  object native extends BenchModule with ScalaNativeModule {
    def scalaNativeVersion = scalaNative
    def moduleDeps = Seq(upickle.native(scala213).test)
    def mvnDeps = Seq(mvn"com.lihaoyi::sourcecode::$sourcecode")
    def allSourceFiles = Task{ super.allSourceFiles().filter(_.path.last != "NonNative.scala") }
    def releaseMode = ReleaseMode.ReleaseFast
    def nativeLTO = LTO.Thin
  }
}
